<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Record/Encode Audio</title>

  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"> 
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css"> 

  <style type='text/css'>
    body{ padding: 15px; margin: 15px;}
    
  </style>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.32.min.js"></script>
<script type="text/javascript">
  // See the Configuring section to configure credentials in the SDK
  AWS.config.update({accessKeyId: 'AKIAIYAMUFYEPYZNLLCQ', secretAccessKey: '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'});
  AWS.config.region = 'us-east-1';
</script>
<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.4.2.min.js"></script>

</head>
<body>
  <div id="info" class="row step">
    <div class="col-md-6 col-md-offset-3">
      <h1>Input Details</h1>
      Story Title: <input type="text" name="storyTitle" id="storyTitle" class="form-control" size="50"><br>
      Your Email: <input type="text" name="userEmail" id="userEmail" class="form-control" size="50"><br>
      <button type="button" class="btn btn-default btn-lg center-block" onclick="submitInfo()" style="color:red">
        <span class="glyphicon glyphicon-record" aria-hidden="true"></span> Record
      </button>

    </div>
  </div>

  <div id="record" class="row step" style="display: none;">
    <div class="col-md-6 col-md-offset-3">
      <h1>Record</h1>
      <button  class="btn btn-default" onclick="startRecording(this);">Record</button>
      <button  class="btn btn-default"  onclick="stopRecording(this);" disabled>Stop</button>
    </div>
  </div>

  <div id="verify" class="row step" style="display: none;">
    <div class="col-md-6 col-md-offset-3">
      <h1>Verify</h1>
      <ul id="recordingslist"></ul>
      <br>
      <button  class="btn btn-default" onclick="submitAll();">Submit</button>
      <br>
      <button  class="btn btn-default" onclick="reRecord();">Record Again</button>

    </div>
  </div>

  <div id="upload" class="row step" style="display: none;">
    <div class="col-md-6 col-md-offset-3">
      <h1>Uploading...</h1><br>
<img class="center-block" style="-webkit-user-select: none; cursor: zoom-in;" src="http://www.mytreedb.com/uploads/mytreedb/loader/ajax_loader_red_512.gif" width="300" height="300">
    </div>
  </div>

  <div id="confirm" class="row step" style="display: none;">
    <div class="col-md-6 col-md-offset-3">
      <h1>Confirm</h1>
      <p>Story submitted!</p>
    </div>
  </div>



  <div id="logger" class="row">
    <div class="col-md-6 col-md-offset-3">
      <h2>Log</h2>
      <pre id="log"></pre>
    </div>
  </div>

  <script>

  function logHTML(e, data) {
    log.innerHTML += "\n" + e + " " + (data || '');
  }

  var audioContext;
  var audioRecorder;

  var _realAudioInput;

  function handlerStartUserMedia(stream) {
    console.log('handlerStartUserMedia');
    console.log('sampleRate:'+ audioContext.sampleRate);

    // MEDIA STREAM SOURCE -> ZERO GAIN >
    _realAudioInput = audioContext.createMediaStreamSource(stream);
    audioRecorder = new Recorder(_realAudioInput);
  }

  function handlerErrorUserMedia(e) {
      logHTML('No live audio input: ' + e);
  }

  function startRecording(button) {
    if(!audioRecorder)
      return;
    audioRecorder && audioRecorder.record();

    //GUI
    button.disabled = true;
    button.nextElementSibling.disabled = false;
    logHTML('Recording...');
  }

  function stopRecording(button) {
    if(!audioRecorder)
      return;

    audioRecorder && audioRecorder.stop();

    //GUI
    button.disabled = true;
    button.previousElementSibling.disabled = false;
    logHTML('Stopped recording.');
    stepToStep("verify");
  }

  function reRecord(e) {
    $(recordingslist).empty();
    stepToStep("record");    
  }

  function submitAll(e) {
    logHTML('Submitting.');
    audioRecorder.uploadAudioToStorage(function() {
      logHTML('Uploaded to storage.');
      audioRecorder.storeNewStory(function(status, object) {
        logHTML('Stored new story.');
        console.log(status);
        console.log(object);
        stepToStep("confirm");
      })
    });

    stepToStep("upload");        
  }

  function submitInfo(e) {
    audioRecorder.userEmail = $("#userEmail").val();
    audioRecorder.storyTitle = $("#storyTitle").val();
    stepToStep("record");
  }

  function stepToStep(step) {
    logHTML("Stepping to step: " + step);
    $(".step").hide();
    $("#"+step).show();
  }

  window.onload = function init() {

    try {
      // webkit shim.
      window.AudioContext = window.AudioContext || window.webkitAudioContext || window.mozAudioContext;
      navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
      window.URL = window.URL || window.webkitURL;
      audioContext = new AudioContext;
      logHTML('Audio context set up.');
      logHTML('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
    } catch (e) {
     alert('No web audio support in this browser!');
    }

    navigator.getUserMedia({vide:false, audio: true}, handlerStartUserMedia, handlerErrorUserMedia);
  };

  </script>

   <script src="js/vendor/jquery-1.11.0.min.js"></script>  
   <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

  <script src="js/recorder.js"></script>

</body>
</html>